Parameters:

  BucketName:
    Type: String
    Description: S3 bucket name that hosts Lambda content

  Architecture:
    Type: String
    Description: Executable architecture for the Lambda function
    AllowedValues:
      - x86_64
      - arm64

  DomainName:
    Type: String
    Description: Domain that will host the server

Outputs:
  InvokeURL:
    Description: "HTTP API URL"
    Value: !Sub "https://${API}.execute-api.${AWS::Region}.amazonaws.com/${APIStage}"

Resources:

  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      Description: "CrossHost Lambda Role"
      RoleName: "CrossHostFunctionRole"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaRole"

  APIGatewayRole:
    Type: AWS::IAM::Role
    Properties:
      Description: API Gateway Role
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - apigateway.amazonaws.com
          Action:
          - sts:AssumeRole
      Path: "/"
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs"

  LambdaLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      Description: "Certificates and Keys"
      Content:
         S3Bucket: !Ref BucketName
         S3Key: CrossHostLambdaLayer.zip

  Lambda:
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
        - !Ref Architecture
      Code:
        S3Bucket: !Ref BucketName
        S3Key: CrossHostHTTPLambda.zip
      Environment:
        Variables:
          LOG_LEVEL: info
          ROUTE_PREFIX: !Ref APIStage
          DOMAIN: !Ref DomainName
      Description: "Swift function that services requests from API Gateway"
      FunctionName: CrossHostHTTPLambda
      Handler: CrossHostHTTPLambda
      Layers:
        - !Ref LambdaLayer
      PackageType: Zip
      Role: !Sub "${LambdaRole.Arn}"
      Runtime: "provided.al2"

  LambdaAPIPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${Lambda.Arn}"
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${API}/*/*/*"

  WebSocketLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WebSocketLambda.Arn}"
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"

  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn: Lambda
    Properties:
      LogGroupName: "/aws/lambda/CrossHost"
      RetentionInDays: 7

  WebSocketLambda:
    Type: AWS::Lambda::Function
    Properties:
      Architectures:
        - !Ref Architecture
      Code:
        S3Bucket: !Ref BucketName
        S3Key: CrossHostWSLambda.zip
      Environment:
        Variables:
          LOG_LEVEL: info
          ROUTE_PREFIX: !Ref WebSocketAPIStage
          DOMAIN: !Ref DomainName
      Description: "Handles requests from API Gateway WebSocket service"
      FunctionName: CrossHostWSLambda
      Handler: CrossHostWSLambda
      Layers:
        - !Ref LambdaLayer
      PackageType: Zip
      Role: !Sub "${LambdaRole.Arn}"
      Runtime: "provided.al2"

  WebSocketLambdaAPIPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Sub "${WebSocketLambda.Arn}"
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:${AWS::Partition}:execute-api:${AWS::Region}:${AWS::AccountId}:${API}/*/*/*"

  WebSocketLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    DependsOn: WebSocketLambda
    Properties:
      LogGroupName: "/aws/lambda/CrossHostWSLambda"
      RetentionInDays: 7

  Certificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: !Ref DomainName
      ValidationMethod: DNS

  APIGatewayAccount:
      Type: AWS::ApiGateway::Account
      Properties:
        CloudWatchRoleArn: !GetAtt APIGatewayRole.Arn

  API:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Description: "CrossHost HTTP API"
      Name: CrossHostHTTP
      ProtocolType: HTTP
      Version: 1

  WebSocketAPI:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Description: "CrossHost WebSocket API"
      Name: CrossHostWS
      ProtocolType: WEBSOCKET
      Version: 1
      RouteSelectionExpression: "$request.body.action"

  WebSocketAPIIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${WebSocketLambda.Arn}/invocations"

  DefaultWebSocketAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: "$default"
      Target: !Sub "integrations/${WebSocketAPIIntegration}"

  ConnectWebSocketAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: "$connect"
      Target: !Sub "integrations/${WebSocketAPIIntegration}"

  DisconnectWebSocketAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: "$disconnect"
      Target: !Sub "integrations/${WebSocketAPIIntegration}"

  APIIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref API
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub "${Lambda.Arn}"
      PayloadFormatVersion: "2.0"

  WebFingerAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /.well-known/webfinger"
      Target: !Sub "integrations/${APIIntegration}"

  RootDIDWebAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /.well-known/did.json"
      Target: !Sub "integrations/${APIIntegration}"

  ATProtoDIDAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /.well-known/atproto-did"
      Target: !Sub "integrations/${APIIntegration}"

  GetATProtoXRPCRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /xrpc/{nsid}"
      Target: !Sub "integrations/${APIIntegration}"

  PostATProtoXRPCRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "POST /xrpc/{nsid}"
      Target: !Sub "integrations/${APIIntegration}"

  NodeInfoProfileAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /.well-known/nodeinfo"
      Target: !Sub "integrations/${APIIntegration}"

  NodeInfoDocumentAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /nodeinfo/{version}"
      Target: !Sub "integrations/${APIIntegration}"

  HostMetaAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /.well-known/host-meta"
      Target: !Sub "integrations/${APIIntegration}"

  GetUserAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /users/{id}"
      Target: !Sub "integrations/${APIIntegration}"

  PostUserInboxAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "POST /users/{id}/inbox"
      Target: !Sub "integrations/${APIIntegration}"

  GetUserOutboxAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /users/{id}/outbox"
      Target: !Sub "integrations/${APIIntegration}"

  GetUserOutboxContentsAPIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref API
      RouteKey: "GET /users/{id}/outbox/contents"
      Target: !Sub "integrations/${APIIntegration}"

  APIStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref API
      AutoDeploy: true
      Description: "API Test Deployment"
      StageName: Test

  WebSocketAPIStage:
    Type: AWS::ApiGatewayV2::Stage
    DependsOn: APIGatewayAccount
    Properties:
      ApiId: !Ref WebSocketAPI
      AutoDeploy: true
      Description: "WebSocket Test Deployment"
      StageName: Test
      DefaultRouteSettings:
          LoggingLevel: INFO
      AccessLogSettings:
        DestinationArn: !GetAtt WebSocketAPILogGroup.Arn
        Format: '{ "requestId": "$context.requestId", "path": "$context.path", "routeKey": "$context.routeKey", "ip": "$context.identity.sourceIp", "requestTime": "$context.requestTime", "httpMethod": "$context.httpMethod","statusCode": $context.status }'

  WebSocketAPILogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/apigateway/ws"
      RetentionInDays: 7

  Distribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - DomainName: !Sub "${API}.execute-api.${AWS::Region}.amazonaws.com"
            Id: HTTPOrigin
            OriginPath: !Sub "/${APIStage}"
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
          - DomainName: !Sub "${WebSocketAPI}.execute-api.${AWS::Region}.amazonaws.com"
            Id: WSOrigin
            OriginPath: !Sub "/${WebSocketAPIStage}"
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: https-only
        Aliases:
          - !Ref DomainName
        ViewerCertificate:
          AcmCertificateArn: !Ref Certificate
          SslSupportMethod: sni-only
        Enabled: true
        DefaultCacheBehavior:
          TargetOriginId: HTTPOrigin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac
        CacheBehaviors:
          - TargetOriginId: WSOrigin
            PathPattern: "/xrpc/com.atproto.sync.subscribeRepos"
            ViewerProtocolPolicy: redirect-to-https
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
            OriginRequestPolicyId: b689b0a8-53d0-40ab-baf2-68738e2966ac
            Compress: false
            FunctionAssociations:
              - EventType: viewer-request
                FunctionARN: !Ref CloudFrontFunction

  CloudFrontFunction:
    Type: AWS::CloudFront::Function
    Properties:
      Name: ClearWebSocketPath
      FunctionConfig:
        Comment: Removes URL path for API Gateway WebSocket API
        Runtime: cloudfront-js-2.0
      FunctionCode: |
        function handler(event) {
          var request = event.request;

          request.uri = '/';

          return request;
        }
      AutoPublish: true
